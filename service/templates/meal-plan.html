{% extends "layout.html" %}

{% block title %}14-Day Meal Plan{% endblock %}

{% block content %}
<div class="page-container">
  <div class="page-header">
    <a href="/dashboard" class="back-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
    </a>
    <h1>Your 14-Day Plan</h1>
  </div>

  <!-- Date Selector -->
  <div class="date-scroll-container">
    <div class="date-scroll" id="date-scroll">
      <!-- Dates will be generated here -->
    </div>
  </div>

  <!-- Selected Day Meals -->
  <div class="day-meals" id="day-meals">
    <div class="day-header">
      <h2 id="selected-date-title">Select a day</h2>
      <div class="day-macros" id="day-macros"></div>
    </div>
    <div class="meals-grid" id="meals-grid">
      <!-- Meals for selected day -->
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedDate = null;
let mealPlans = {};

const mealIcons = {
  breakfast: 'üç≥',
  mid_morning_snack: 'üçé',
  lunch: 'üçõ',
  evening_snack: '‚òï',
  dinner: 'ü•ó'
};

const mealLabels = {
  breakfast: 'Breakfast',
  mid_morning_snack: 'Mid-morning Snack',
  lunch: 'Lunch',
  evening_snack: 'Evening Snack',
  dinner: 'Dinner'
};

async function loadMealPlan() {
  try {
    const profileRes = await fetch('/api/profile');
    const profile = await profileRes.json();
    
    renderDateSelector(profile);
    
    // Select today by default
    const today = new Date().toISOString().split('T')[0];
    selectDate(today);
    
  } catch (error) {
    console.error('Error loading meal plan:', error);
  }
}

function renderDateSelector(profile) {
  const dateScroll = document.getElementById('date-scroll');
  dateScroll.innerHTML = '';
  
  const startDate = new Date(profile.plan_start_date);
  const today = new Date().toISOString().split('T')[0];
  
  for (let i = 0; i < 14; i++) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + i);
    const dateStr = date.toISOString().split('T')[0];
    
    const isToday = dateStr === today;
    const dayNum = i + 1;
    
    const dateBtn = document.createElement('button');
    dateBtn.className = 'date-btn' + (isToday ? ' today' : '');
    dateBtn.onclick = () => selectDate(dateStr);
    dateBtn.innerHTML = `
      <div class="date-day">${date.toLocaleDateString('en', { weekday: 'short' })}</div>
      <div class="date-number">${date.getDate()}</div>
      <div class="date-month">${date.toLocaleDateString('en', { month: 'short' })}</div>
      ${isToday ? '<div class="today-indicator">Today</div>' : ''}
    `;
    
    dateScroll.appendChild(dateBtn);
  }
}

async function selectDate(dateStr) {
  selectedDate = dateStr;
  
  // Update active state
  document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
  event?.target?.closest('.date-btn')?.classList.add('active');
  
  // Load meals for this date
  try {
    const response = await fetch(`/api/meal-plan?date=${dateStr}`);
    const plan = await response.json();
    
    mealPlans[dateStr] = plan;
    renderDayMeals(plan, dateStr);
    
  } catch (error) {
    console.error('Error loading meals for date:', error);
  }
}

function renderDayMeals(plan, dateStr) {
  const date = new Date(dateStr);
  document.getElementById('selected-date-title').textContent = 
    date.toLocaleDateString('en', { weekday: 'long', month: 'long', day: 'numeric' });
  
  // Calculate total macros
  let totalCalories = 0;
  let totalProtein = 0;
  let totalCarbs = 0;
  let totalFats = 0;
  
  if (plan) {
    ['breakfast', 'mid_morning_snack', 'lunch', 'evening_snack', 'dinner'].forEach(mealType => {
      const meal = plan[mealType];
      if (meal) {
        totalCalories += meal.calories || 0;
        totalProtein += meal.protein || 0;
        totalCarbs += meal.carbs || 0;
        totalFats += meal.fats || 0;
      }
    });
  }
  
  document.getElementById('day-macros').innerHTML = `
    <span class="macro">${totalCalories} kcal</span>
    <span class="macro blue">P: ${totalProtein}g</span>
    <span class="macro amber">C: ${totalCarbs}g</span>
    <span class="macro green">F: ${totalFats}g</span>
  `;
  
  // Render meals
  const mealsGrid = document.getElementById('meals-grid');
  mealsGrid.innerHTML = '';
  
  if (!plan) {
    mealsGrid.innerHTML = '<p class="no-meals">No meal plan for this day.</p>';
    return;
  }
  
  ['breakfast', 'mid_morning_snack', 'lunch', 'evening_snack', 'dinner'].forEach(mealType => {
    const meal = plan[mealType];
    if (!meal) return;
    
    const mealCard = document.createElement('a');
    mealCard.href = `/meal-detail?date=${dateStr}&meal=${mealType}`;
    mealCard.className = 'meal-plan-card';
    mealCard.innerHTML = `
      <div class="meal-card-icon">${mealIcons[mealType]}</div>
      <div class="meal-card-content">
        <div class="meal-card-label">${mealLabels[mealType]}</div>
        <h3 class="meal-card-name">${meal.name}</h3>
        ${meal.description ? `<p class="meal-card-desc">${meal.description}</p>` : ''}
        <div class="meal-card-macros">
          <span>${meal.calories} kcal</span>
          <span class="blue">P: ${meal.protein}g</span>
          <span class="amber">C: ${meal.carbs}g</span>
          <span class="green">F: ${meal.fats}g</span>
        </div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
    `;
    
    mealsGrid.appendChild(mealCard);
  });
}

loadMealPlan();
</script>
{% endblock %}
