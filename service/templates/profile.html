{% extends "layout.html" %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="page-container">
  <div class="page-header">
    <a href="/dashboard" class="back-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
    </a>
    <h1>Profile</h1>
  </div>

  <div class="profile-content">
    <!-- User Info Card -->
    <div class="profile-card">
      <div class="profile-avatar">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div class="profile-info">
        <h2 id="user-name">User</h2>
        <p id="user-email"></p>
        <div class="profile-badges">
          <span class="badge" id="diet-badge"></span>
          <span class="badge" id="region-badge"></span>
        </div>
      </div>
    </div>

    <!-- Cycle Progress -->
    <div class="cycle-card">
      <div class="cycle-header">
        <div class="cycle-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
          <span>Cycle <span id="cycle-num">1</span></span>
        </div>
        <span class="cycle-remaining" id="days-remaining"></span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="cycle-progress"></div>
      </div>
      <div class="progress-labels">
        <span>Day <span id="current-day-num">1</span></span>
        <span>Day 14</span>
      </div>
    </div>

    <!-- Body Stats -->
    <div class="stats-grid">
      <div class="stat-card-large">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18"/><path d="m15 18-3 3-3-3"/><path d="M4 9h16"/></svg>
        </div>
        <div class="stat-content">
          <div class="stat-label-small">Current</div>
          <div class="stat-value-large" id="current-weight-profile">— kg</div>
          <div class="stat-change" id="weight-change"></div>
        </div>
      </div>
      <div class="stat-card-large">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        </div>
        <div class="stat-content">
          <div class="stat-label-small">Target</div>
          <div class="stat-value-large" id="target-weight-profile">— kg</div>
          <div class="progress-bar-small">
            <div class="progress-fill-small" id="target-progress"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Metabolic Profile -->
    <div class="detail-card">
      <h3>Metabolic Profile</h3>
      <div class="metabolic-grid">
        <div class="metabolic-item">
          <div class="metabolic-label">BMI</div>
          <div class="metabolic-value" id="bmi-value">—</div>
          <div class="metabolic-status" id="bmi-status">—</div>
        </div>
        <div class="metabolic-item">
          <div class="metabolic-label">BMR</div>
          <div class="metabolic-value" id="bmr-value">—</div>
          <div class="metabolic-status">kcal at rest</div>
        </div>
        <div class="metabolic-item">
          <div class="metabolic-label">TDEE</div>
          <div class="metabolic-value" id="tdee-value">—</div>
          <div class="metabolic-status">total daily burn</div>
        </div>
        <div class="metabolic-item">
          <div class="metabolic-label">Daily Target</div>
          <div class="metabolic-value" id="daily-calories-value">—</div>
          <div class="metabolic-status">for your goals</div>
        </div>
      </div>
    </div>

    <!-- Daily Targets -->
    <div class="detail-card">
      <h3>Daily Macro Targets</h3>
      <div class="macro-targets">
        <div class="macro-target-item">
          <div class="macro-target-header">
            <span>Protein</span>
            <span class="macro-target-value" id="protein-target">—g</span>
          </div>
          <div class="macro-progress-bar">
            <div class="macro-progress-fill blue"></div>
          </div>
        </div>
        <div class="macro-target-item">
          <div class="macro-target-header">
            <span>Carbs</span>
            <span class="macro-target-value" id="carbs-target">—g</span>
          </div>
          <div class="macro-progress-bar">
            <div class="macro-progress-fill amber"></div>
          </div>
        </div>
        <div class="macro-target-item">
          <div class="macro-target-header">
            <span>Fats</span>
            <span class="macro-target-value" id="fats-target">—g</span>
          </div>
          <div class="macro-progress-bar">
            <div class="macro-progress-fill green"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Health Profile -->
    <div class="detail-card">
      <h3>Health Profile</h3>
      
      <div class="health-section">
        <div class="health-label">Goals</div>
        <div class="badge-list" id="goals-list"></div>
      </div>
      
      <div class="health-section" id="conditions-section" style="display:none;">
        <div class="health-label">Medical Conditions</div>
        <div class="badge-list" id="conditions-list"></div>
      </div>
      
      <div class="health-section" id="allergies-section" style="display:none;">
        <div class="health-label">Allergies</div>
        <div class="badge-list" id="allergies-list"></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="profile-actions">
      <button class="btn-secondary btn-large" onclick="regeneratePlan()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
        Generate New 14-Day Plan
      </button>
      <a href="/onboarding" class="btn-secondary btn-large">
        Update Profile
      </a>
      <button class="btn-secondary btn-large" onclick="logout()" style="margin-top: 16px; border: 2px solid #ef4444; color: #ef4444;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        Logout
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Check if user is logged in
if (!localStorage.getItem('userEmail')) {
  window.location.href = '/login';
}

async function loadProfile() {
  try {
    const response = await fetch('/api/profile');
    const profile = await response.json();
    
    renderProfile(profile);
    
  } catch (error) {
    console.error('Error loading profile:', error);
  }
}

function renderProfile(profile) {
  // User info
  document.getElementById('user-name').textContent = profile.name || 'User';
  document.getElementById('user-email').textContent = profile.email || '';
  document.getElementById('diet-badge').textContent = (profile.diet_type || '').replace('_', ' ');
  document.getElementById('region-badge').textContent = (profile.region || '').replace('_', ' ');
  
  // Cycle progress
  const startDate = new Date(profile.plan_start_date);
  const today = new Date();
  const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
  const currentDay = Math.min(Math.max(daysDiff, 1), 14);
  const daysRemaining = Math.max(14 - currentDay, 0);
  const progressPercent = (currentDay / 14) * 100;
  
  document.getElementById('cycle-num').textContent = profile.current_plan_cycle || 1;
  document.getElementById('days-remaining').textContent = daysRemaining + ' days remaining';
  document.getElementById('current-day-num').textContent = currentDay;
  document.getElementById('cycle-progress').style.width = progressPercent + '%';
  
  // Body stats
  document.getElementById('current-weight-profile').textContent = profile.weight + ' kg';
  
  // Show BMI category as goal indicator
  const bmiCategory = profile.bmi < 18.5 ? 'Underweight' 
    : profile.bmi < 25 ? 'Normal' 
    : profile.bmi < 30 ? 'Overweight' : 'Obese';
  const weightChangeEl = document.getElementById('weight-change');
  weightChangeEl.innerHTML = `BMI Category: ${bmiCategory}`;
  weightChangeEl.className = 'stat-change';
  
  // Progress based on plan completion
  const progressToGoal = 50; // Based on plan adherence
  document.getElementById('target-progress').style.width = progressToGoal + '%';
  
  // Metabolic profile
  document.getElementById('bmi-value').textContent = profile.bmi;
  const bmiStatus = profile.bmi < 18.5 ? 'Underweight' 
    : profile.bmi < 25 ? 'Normal' 
    : profile.bmi < 30 ? 'Overweight' : 'Obese';
  document.getElementById('bmi-status').textContent = bmiStatus;
  
  document.getElementById('bmr-value').textContent = profile.bmr + ' kcal';
  document.getElementById('tdee-value').textContent = profile.tdee + ' kcal';
  document.getElementById('daily-calories-value').textContent = profile.daily_calories + ' kcal';
  
  // Macro targets
  document.getElementById('protein-target').textContent = profile.daily_protein + 'g';
  document.getElementById('carbs-target').textContent = profile.daily_carbs + 'g';
  document.getElementById('fats-target').textContent = profile.daily_fats + 'g';
  
  // Goals
  if (profile.goals && profile.goals.length > 0) {
    document.getElementById('goals-list').innerHTML = profile.goals.map(goal => 
      `<span class="badge black">${goal.replace(/_/g, ' ')}</span>`
    ).join('');
  }
  
  // Medical conditions
  if (profile.medical_conditions && profile.medical_conditions.length > 0) {
    document.getElementById('conditions-section').style.display = 'block';
    document.getElementById('conditions-list').innerHTML = profile.medical_conditions.map(condition => 
      `<span class="badge outline">${condition}</span>`
    ).join('');
  }
  
  // Allergies
  if (profile.allergies && profile.allergies.length > 0) {
    document.getElementById('allergies-section').style.display = 'block';
    document.getElementById('allergies-list').innerHTML = profile.allergies.map(allergy => 
      `<span class="badge red">${allergy}</span>`
    ).join('');
  }
}

async function regeneratePlan() {
  if (!confirm('This will generate a new 14-day meal plan. Continue?')) {
    return;
  }
  
  try {
    // Increment cycle and reset start date
    await fetch('/api/profile/new-cycle', { method: 'POST' });
    window.location.href = '/get-recommendations';
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('userEmail');
    window.location.href = '/login';
  }
}

loadProfile();
</script>
{% endblock %}
